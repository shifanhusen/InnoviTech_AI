name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Ubuntu Server via SSH
        uses: appleboy/ssh-action@v0.1.10   # same major version as your working project
        with:
          host: "72.60.42.121"
          username: "root"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # If your SSH runs on a custom port, uncomment and set:
          # port: "YOUR_PORT_HERE"
          script: |
            set -e

            # Use secret PROJECT_PATH if set, otherwise default to /root/ai-assistant
            PROJECT_DIR="${{ secrets.PROJECT_PATH || '/root/ai-assistant' }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo "ğŸš€ Starting deployment on $(hostname)..."
            echo "ğŸ“ Using project directory: $PROJECT_DIR"

            # Make sure parent directory exists
            mkdir -p "$(dirname "$PROJECT_DIR")"

            if [ -d "$PROJECT_DIR/.git" ]; then
              echo "âœ… Project directory exists. Pulling latest code..."
              cd "$PROJECT_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "ğŸ¤” Project directory does not exist. Cloning repository..."
              rm -rf "$PROJECT_DIR"
              git clone "$REPO_URL" "$PROJECT_DIR"
              cd "$PROJECT_DIR"
            fi
            
            echo "ğŸ›‘ Stopping existing containers (if any)..."
            docker compose down --remove-orphans || true
            
            echo "ğŸ”¨ Building Docker images..."
            docker compose build --no-cache
            
            echo "â–¶ï¸ Starting services (excluding Ollama to avoid 11434 conflict)..."
            # Adjust service list to match docker-compose.yml; exclude ollama when system Ollama is already running
            docker compose up -d redis backend frontend nginx
            
            echo "â³ Waiting for services to start..."
            sleep 30
            
            echo "ğŸ¤– Skipping Ollama container/model checks (using system Ollama on port 11434)."
            # Ensure backend points to system Ollama
            if [ -f backend/.env ]; then
              sed -i 's#^OLLAMA_BASE_URL=.*#OLLAMA_BASE_URL=http://127.0.0.1:11434#' backend/.env || true
            else
              echo "OLLAMA_BASE_URL=http://127.0.0.1:11434" >> backend/.env
            fi
            
            echo "ğŸ¥ Running backend health check with retries..."
            for i in {1..5}; do
              if curl -fsS http://localhost:5001/api/health >/dev/null; then
                echo "âœ… Backend is healthy"
                break
              else
                echo "âŒ Backend health check attempt $i failed. Retrying in 5s..."
                sleep 5
              fi
              if [ $i -eq 5 ]; then
                echo "âŒ Backend failed to become healthy after 5 attempts. See logs:"
                docker compose logs backend || true
                exit 1
              fi
            done
            
            echo "ğŸ¥ Running nginx health check with retries..."
            for i in {1..5}; do
              if curl -fsS http://localhost/api/health >/dev/null; then
                echo "âœ… Nginx is healthy"
                break
              else
                echo "âŒ Nginx health check attempt $i failed. Retrying in 5s..."
                sleep 5
              fi
              if [ $i -eq 5 ]; then
                echo "âŒ Nginx failed to become healthy after 5 attempts. See logs:"
                docker compose logs nginx || true
                exit 1
              fi
            done
            
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f || true
            
            echo "ğŸ“Š Currently running containers:"
            docker compose ps
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application is now live!"

      - name: Deployment Status Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production server succeeded!"
          else
            echo "âŒ Deployment to production server failed!"
          fi

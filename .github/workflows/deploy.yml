name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Ubuntu Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: "72.60.42.121"
          username: "root"
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # Use secret PROJECT_PATH if set, otherwise default to /root/ai-assistant
            PROJECT_DIR="${{ secrets.PROJECT_PATH || '/root/ai-assistant' }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"

            echo "üöÄ Starting deployment on $(hostname)..."
            echo "üìÅ Using project directory: $PROJECT_DIR"

            # Make sure parent directory exists
            mkdir -p "$(dirname "$PROJECT_DIR")"

            if [ -d "$PROJECT_DIR/.git" ]; then
              echo "‚úÖ Project directory exists. Pulling latest code..."
              cd "$PROJECT_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "ü§î Project directory does not exist. Cloning repository..."
              rm -rf "$PROJECT_DIR"
              git clone "$REPO_URL" "$PROJECT_DIR"
              cd "$PROJECT_DIR"
            fi
            
            echo "üõë Stopping existing containers (if any)..."
            docker compose down --remove-orphans || true
            
            echo "üîß Ensuring backend configuration..."
            # Get the host gateway IP for Docker bridge network
            HOST_IP=$(ip route | grep default | awk '{print $3}')
            echo "Host gateway IP: $HOST_IP"
            
            # Ensure backend listens on correct port and host and correct Ollama base URL
            if [ -f backend/.env ]; then
              sed -i 's#^PORT=.*#PORT=5001#' backend/.env || echo "PORT=5001" >> backend/.env
              sed -i 's#^HOST=.*#HOST=0.0.0.0#' backend/.env || echo "HOST=0.0.0.0" >> backend/.env
              sed -i 's#^OLLAMA_BASE_URL=.*#OLLAMA_BASE_URL=http://'"$HOST_IP"':11434#' backend/.env || echo "OLLAMA_BASE_URL=http://$HOST_IP:11434" >> backend/.env
            else
              echo "PORT=5001" >> backend/.env
              echo "HOST=0.0.0.0" >> backend/.env
              echo "OLLAMA_BASE_URL=http://$HOST_IP:11434" >> backend/.env
            fi
            
            echo "Backend will use Ollama at: http://$HOST_IP:11434"
            
            echo "üé® Building frontend..."
            # Build frontend dist folder (nginx mounts this directory)
            cd frontend
            if ! command -v npm &> /dev/null; then
              echo "Installing Node.js and npm..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            npm ci
            npm run build
            cd ..
            
            echo "üî® Building and starting services..."
            # Build and start core services; frontend container uses dev profile, nginx serves pre-built dist
            docker compose up -d --build --remove-orphans redis backend nginx
            
            echo "‚è≥ Waiting for initial startup..."
            sleep 15
            
            echo "üìä Container status after startup:"
            docker compose ps
            
            echo "üè• Running backend health check with retries..."
            MAX_ATTEMPTS=12
            for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "Attempt $i/$MAX_ATTEMPTS: checking http://localhost:5001/api/health"
              if curl -fsS http://localhost:5001/api/health >/dev/null 2>&1; then
                echo "‚úÖ Backend is healthy"
                break
              fi
            
              echo "‚ùå Backend health check attempt $i failed. Printing last 200 lines of backend logs:"
              docker compose logs --no-color --tail=200 backend || true
            
              # Backoff: small sleeps early, longer later
              if [ $i -lt 6 ]; then
                sleep 5
              else
                sleep 10
              fi
            
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå Backend failed to become healthy after $MAX_ATTEMPTS attempts. Full backend logs:"
                docker compose logs --no-color backend || true
                echo "Backend container inspect:"
                docker inspect --format='{{json .State}}' $(docker compose ps -q backend) || true
                exit 1
              fi
            done
            
            echo "üè• Running nginx health check with retries..."
            MAX_ATTEMPTS=12
            for i in $(seq 1 $MAX_ATTEMPTS); do
              echo "Attempt $i/$MAX_ATTEMPTS: checking http://localhost:8080/api/health"
              if curl -fsS http://localhost:8080/api/health >/dev/null 2>&1; then
                echo "‚úÖ Nginx is healthy"
                break
              fi
            
              echo "‚ùå Nginx health check attempt $i failed. Printing last 200 lines of nginx logs:"
              docker compose logs --no-color --tail=200 nginx || true
            
              if [ $i -lt 6 ]; then
                sleep 5
              else
                sleep 10
              fi
            
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå Nginx failed to become healthy after $MAX_ATTEMPTS attempts. Full nginx logs:"
                docker compose logs --no-color nginx || true
                echo "Nginx container inspect:"
                docker inspect --format='{{json .State}}' $(docker compose ps -q nginx) || true
                exit 1
              fi
            done
            
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f || true
            
            echo "üìä Currently running containers:"
            docker compose ps
            
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Application is now live at: http://72.60.42.121:8080"
      
      - name: Deployment Status Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment to production server succeeded!"
          else
            echo "‚ùå Deployment to production server failed!"
          fi

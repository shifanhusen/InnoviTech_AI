name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  BACKEND_REPO: ${{ secrets.DOCKER_REPO_BACKEND || 'your-username/ai-assistant-backend' }}
  FRONTEND_REPO: ${{ secrets.DOCKER_REPO_FRONTEND || 'your-username/ai-assistant-frontend' }}
  NGINX_REPO: ${{ secrets.DOCKER_REPO_NGINX || 'your-username/ai-assistant-nginx' }}

jobs:
  build-backend:
    name: Build and Push Backend Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
      
      # Alternative: Log in to GitHub Container Registry
      # Uncomment below and comment out Docker Hub login above to use GHCR
      # - name: Log in to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_REPO }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=semver,pattern={{version}}
      
      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.BACKEND_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_REPO }}:buildcache,mode=max
          platforms: linux/amd64

      - name: Image digest
        run: echo "Backend image digest - ${{ steps.meta.outputs.digest }}"

  build-frontend:
    name: Build and Push Frontend Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_REPO }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=semver,pattern={{version}}
      
      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.FRONTEND_REPO }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_REPO }}:buildcache,mode=max
          platforms: linux/amd64
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL || 'http://localhost:5001' }}

      - name: Image digest
        run: echo "Frontend image digest - ${{ steps.meta.outputs.digest }}"

  build-nginx:
    name: Build and Push Nginx Image
    runs-on: ubuntu-latest
    needs: build-frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build frontend first
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Create Nginx Dockerfile
        run: |
          cat > nginx/Dockerfile << 'EOF'
          FROM nginx:alpine
          
          # Copy built frontend assets
          COPY ../frontend/dist /usr/share/nginx/html
          
          # Copy nginx configuration
          COPY nginx.conf /etc/nginx/nginx.conf
          COPY conf.d /etc/nginx/conf.d
          
          EXPOSE 80 443
          
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.NGINX_REPO }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
      
      - name: Build and push Nginx Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./nginx/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64

      - name: Image digest
        run: echo "Nginx image digest - ${{ steps.meta.outputs.digest }}"

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-nginx]
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All Docker images built and pushed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ env.BACKEND_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.FRONTEND_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: \`${{ env.NGINX_REPO }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy" >> $GITHUB_STEP_SUMMARY
          echo "Pull the latest images on your VPS:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker compose pull" >> $GITHUB_STEP_SUMMARY
          echo "docker compose up -d" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
